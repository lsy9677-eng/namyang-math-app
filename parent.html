<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ë¶€ëª¨ ì•Œë¦¼ì¥ | ë¯¸ë˜ì—”ìˆ˜í•™</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <style>
        body { margin: 0; padding: 20px; font-family: 'Pretendard', sans-serif; background: #f1f5f9; color: #333; }
        .container { max-width: 600px; margin: 0 auto; }
        
        .card { background: white; border-radius: 20px; padding: 25px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; }
        .card.left { text-align: left; }
        
        h2 { margin: 10px 0 5px; font-size: 22px; }
        .info { color: #666; font-size: 14px; margin-bottom: 15px; }
        
        .notice-box { background: #fffbeb; border: 1px solid #fcd34d; padding: 15px; border-radius: 12px; text-align: left; line-height: 1.6; white-space: pre-wrap; }
        
        textarea { width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 10px; margin-top: 10px; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; background: #3b82f6; color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="container">
        <div id="loading" style="text-align:center; padding:50px;">
            ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
        </div>

        <div id="content" style="display:none;">
            <div class="card">
                <img src="nam-192.png" style="width:80px; border-radius:20px; box-shadow:0 5px 15px rgba(0,0,0,0.1);">
                <h2 id="sName">í•™ìƒ ì´ë¦„</h2>
                <div class="info" id="sInfo">í•™êµ | í•™ë…„</div>
                <div style="background:#f0f9ff; color:#0369a1; padding:10px; border-radius:10px; font-weight:bold;">
                    ì´ë²ˆ ë‹¬ ë“±ì›: <span id="sAtt">0</span>íšŒ
                </div>
            </div>

            <div class="card left">
                <h3 style="margin-top:0;">ğŸ“¢ ì„ ìƒë‹˜ ì•Œë¦¼</h3>
                <div id="sNotice" class="notice-box">ë‚´ìš© ì—†ìŒ</div>
            </div>

            <div class="card left">
                <h3 style="margin-top:0;">ğŸ’¬ ì„ ìƒë‹˜ê»˜ ë‹µì¥í•˜ê¸°</h3>
                <textarea id="replyMsg" placeholder="ì„ ìƒë‹˜ê»˜ ë“œë¦´ ë§ì”€ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>
                <button class="btn" onclick="sendReply()">ë³´ë‚´ê¸°</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDPLl5y5xMBL07yLyQDU185qfYLa4c3yv4",
            authDomain: "namyang-f3a98.firebaseapp.com",
            projectId: "namyang-f3a98",
            storageBucket: "namyang-f3a98.firebasestorage.app",
            messagingSenderId: "641432133626",
            appId: "1:641432133626:web:4d31e36d5dbb0db4df4e43",
            measurementId: "G-23L6KZERMF"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentStudentId = null;
        let currentToken = null;

        window.onload = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            currentToken = token;

            if (!token) return alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤ (í† í° ì—†ìŒ).");

            try {
                // 1. í† í°ìœ¼ë¡œ í•™ìƒ ID ì°¾ê¸°
                const tSnap = await getDoc(doc(db, "noticeTokens", token));
                if (!tSnap.exists()) return alert("ìœ íš¨í•˜ì§€ ì•Šì€ ë§í¬ì…ë‹ˆë‹¤.");
                
                const studentId = tSnap.data().studentId;
                currentStudentId = studentId;

                // 2. í•™ìƒ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const sSnap = await getDoc(doc(db, "students", studentId));
                if (!sSnap.exists()) return alert("í•™ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");

                const s = sSnap.data();

                // 3. í™”ë©´ í‘œì‹œ
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';

                document.getElementById('sName').innerText = s.name;
                document.getElementById('sInfo').innerText = (s.school || "") + " " + (s.belt || "");
                document.getElementById('sNotice').innerText = s.lastNotice || "ì•Œë¦¼ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.";

                // ì¶œì„ ê³„ì‚°
                const now = new Date();
                const logs = (s.attendanceLog || []).map(ts => ts.toDate ? ts.toDate() : new Date(ts.seconds * 1000));
                const count = logs.filter(d => d.getMonth() === now.getMonth()).length;
                document.getElementById('sAtt').innerText = count;

            } catch(e) {
                console.error(e);
                alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
            }
        };

        window.sendReply = async () => {
            const msg = document.getElementById('replyMsg').value;
            if(!msg) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");
            
            try {
                await addDoc(collection(db, "parentMessages"), {
                    token: currentToken,
                    studentId: currentStudentId,
                    message: msg,
                    createdAt: serverTimestamp(),
                    read: false
                });
                alert("ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                document.getElementById('replyMsg').value = "";
            } catch(e) { alert("ì „ì†¡ ì‹¤íŒ¨: " + e.message); }
        };
    </script>
</body>
</html>